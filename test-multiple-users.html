<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-User Queue Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        .controls input, .controls select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .controls button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .controls button:hover {
            background: #0056b3;
        }
        .controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .user-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        .user-card.success {
            border-color: #28a745;
            background: #f8fff9;
        }
        .user-card.error {
            border-color: #dc3545;
            background: #fff8f8;
        }
        .user-card.processing {
            border-color: #ffc107;
            background: #fffdf7;
        }
        .user-header {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status {
            font-size: 0.9em;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .status.queued { background: #fff3cd; color: #856404; }
        .status.processing { background: #cce5ff; color: #004085; }
        .status.completed { background: #d4edda; color: #155724; }
        .status.failed { background: #f8d7da; color: #721c24; }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #eee;
            border-radius: 3px;
            margin: 8px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .summary {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .summary-item {
            text-align: center;
        }
        .summary-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .summary-label {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš€ Multi-User Queue System Test</h1>
            <p>Test the CV processing queue with multiple concurrent users</p>
        </div>

        <div class="controls">
            <label>
                Number of Users:
                <select id="userCount">
                    <option value="3">3 Users</option>
                    <option value="5" selected>5 Users</option>
                    <option value="10">10 Users</option>
                    <option value="20">20 Users</option>
                </select>
            </label>
            
            <label>
                Server URL:
                <input type="text" id="serverUrl" value="http://localhost:3000" placeholder="Server URL">
            </label>
            
            <button id="startTest" onclick="startMultiUserTest()">Start Test</button>
            <button id="stopTest" onclick="stopTest()" disabled>Stop Test</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>

        <div class="summary" id="summarySection" style="display: none;">
            <h3>ðŸ“Š Test Summary</h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-number" id="totalUsers">0</div>
                    <div class="summary-label">Total Users</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="successCount">0</div>
                    <div class="summary-label">Completed</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="errorCount">0</div>
                    <div class="summary-label">Failed</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="avgTime">0s</div>
                    <div class="summary-label">Avg Time</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="successRate">0%</div>
                    <div class="summary-label">Success Rate</div>
                </div>
            </div>
        </div>

        <div class="test-results" id="testResults"></div>

        <div class="logs" id="logOutput"></div>
    </div>

    <script>
        let testUsers = [];
        let isTestRunning = false;
        let testStartTime = 0;

        // Generate mock users
        const generateMockUsers = (count) => {
            const names = [
                'Alice Johnson', 'Bob Smith', 'Charlie Brown', 'Diana Prince', 'Eve Wilson',
                'Frank Miller', 'Grace Lee', 'Henry Ford', 'Iris Chen', 'Jack Wilson',
                'Kate Adams', 'Liam Davis', 'Maya Patel', 'Noah Garcia', 'Olivia Martinez',
                'Paul Rodriguez', 'Quinn Taylor', 'Ruby Anderson', 'Sam Thompson', 'Tina White'
            ];
            
            return names.slice(0, count).map((name, index) => ({
                id: index + 1,
                name: name,
                email: `${name.toLowerCase().replace(' ', '.')}@testqueue.com`,
                status: 'waiting',
                position: null,
                jobId: null,
                startTime: null,
                endTime: null,
                error: null,
                progress: 0
            }));
        };

        // Create mock CV file for user
        const createMockCVFile = (user) => {
            const cvContent = `CV Test Document

Name: ${user.name}
Email: ${user.email}
Phone: +1-555-${String(user.id).padStart(4, '0')}

Professional Summary:
Experienced software developer with ${user.id + 2} years of experience.

Work Experience:
Senior Developer - Tech Company ${user.id}
- Led development of critical applications
- Managed team of ${user.id + 1} developers

Skills:
JavaScript, React, Node.js, PostgreSQL, AWS

Education:
Computer Science - University ${user.id}
Graduated: 202${user.id % 4}`;

            return new Blob([cvContent], { type: 'text/plain' });
        };

        // Log message
        const log = (message) => {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logOutput');
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        };

        // Update user card
        const updateUserCard = (user) => {
            let card = document.getElementById(`user-${user.id}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `user-${user.id}`;
                card.className = 'user-card';
                document.getElementById('testResults').appendChild(card);
            }

            const statusClass = user.status === 'completed' ? 'success' : 
                              user.status === 'failed' ? 'error' : 
                              user.status === 'processing' || user.status === 'queued' ? 'processing' : '';
            
            card.className = `user-card ${statusClass}`;
            
            const duration = user.endTime && user.startTime ? 
                ((user.endTime - user.startTime) / 1000).toFixed(1) + 's' : 
                user.startTime ? ((Date.now() - user.startTime) / 1000).toFixed(1) + 's' : 'N/A';

            card.innerHTML = `
                <div class="user-header">
                    <span>${user.name}</span>
                    <span class="status ${user.status}">${user.status.toUpperCase()}</span>
                </div>
                <div>Position: ${user.position || 'N/A'}</div>
                <div>Job ID: ${user.jobId ? user.jobId.substring(0, 8) + '...' : 'N/A'}</div>
                <div>Duration: ${duration}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${user.progress}%"></div>
                </div>
                ${user.error ? `<div style="color: red; font-size: 12px; margin-top: 8px;">${user.error}</div>` : ''}
            `;
        };

        // Update summary
        const updateSummary = () => {
            const completed = testUsers.filter(u => u.status === 'completed').length;
            const failed = testUsers.filter(u => u.status === 'failed').length;
            const avgTime = testUsers.filter(u => u.endTime && u.startTime)
                .reduce((sum, u) => sum + (u.endTime - u.startTime), 0) / 
                Math.max(testUsers.filter(u => u.endTime && u.startTime).length, 1) / 1000;

            document.getElementById('totalUsers').textContent = testUsers.length;
            document.getElementById('successCount').textContent = completed;
            document.getElementById('errorCount').textContent = failed;
            document.getElementById('avgTime').textContent = avgTime.toFixed(1) + 's';
            document.getElementById('successRate').textContent = 
                testUsers.length > 0 ? ((completed / testUsers.length) * 100).toFixed(1) + '%' : '0%';
        };

        // Test single user
        const testSingleUser = async (user, serverUrl) => {
            try {
                log(`[${user.name}] Starting test...`);
                user.status = 'uploading';
                user.progress = 10;
                updateUserCard(user);

                // Create FormData with mock CV file
                const formData = new FormData();
                const mockFile = createMockCVFile(user);
                formData.append('cvFile', mockFile, `${user.name.replace(' ', '-')}-cv.txt`);

                // Note: This is a demo interface - actual testing requires authentication
                // For real testing, use the Node.js test scripts instead
                log(`[${user.name}] âš ï¸ Demo mode - use Node.js scripts for real testing`);
                
                // Simulate the testing process
                await new Promise(resolve => setTimeout(resolve, 1000));
                user.status = 'queued';
                user.position = Math.floor(Math.random() * 5) + 1;
                user.jobId = 'demo-job-' + Math.random().toString(36).substr(2, 9);
                user.progress = 30;
                user.startTime = Date.now();
                updateUserCard(user);
                log(`[${user.name}] Queued at position ${user.position}`);

                await new Promise(resolve => setTimeout(resolve, 2000));
                user.status = 'processing';
                user.progress = 60;
                updateUserCard(user);
                log(`[${user.name}] Processing started...`);

                await new Promise(resolve => setTimeout(resolve, 3000 + Math.random() * 5000));
                
                // Random success/failure for demo
                if (Math.random() > 0.2) { // 80% success rate
                    user.status = 'completed';
                    user.progress = 100;
                    user.endTime = Date.now();
                    log(`[${user.name}] âœ… Completed successfully`);
                } else {
                    user.status = 'failed';
                    user.progress = 0;
                    user.endTime = Date.now();
                    user.error = 'Demo failure simulation';
                    log(`[${user.name}] âŒ Failed: ${user.error}`);
                }
                
                updateUserCard(user);
                
            } catch (error) {
                user.status = 'failed';
                user.error = error.message;
                user.endTime = Date.now();
                updateUserCard(user);
                log(`[${user.name}] âŒ Error: ${error.message}`);
            }
        };

        // Start multi-user test
        const startMultiUserTest = async () => {
            if (isTestRunning) return;

            const userCount = parseInt(document.getElementById('userCount').value);
            const serverUrl = document.getElementById('serverUrl').value;

            testUsers = generateMockUsers(userCount);
            isTestRunning = true;
            testStartTime = Date.now();

            document.getElementById('startTest').disabled = true;
            document.getElementById('stopTest').disabled = false;
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('summarySection').style.display = 'block';

            log(`ðŸš€ Starting multi-user test with ${userCount} users`);
            log(`ðŸ“¡ Server URL: ${serverUrl}`);
            log(`âš ï¸ This is a demo interface. For real HTTP testing, use:`);
            log(`   node test-multiple-users.js`);
            log(`âš ï¸ For local testing without HTTP server, use:`);
            log(`   node test-queue-local.js`);

            // Start all user tests concurrently
            const promises = testUsers.map(user => testSingleUser(user, serverUrl));
            
            // Monitor progress
            const progressInterval = setInterval(() => {
                if (!isTestRunning) {
                    clearInterval(progressInterval);
                    return;
                }
                updateSummary();
            }, 500);

            try {
                await Promise.all(promises);
                log(`ðŸŽ‰ All tests completed in ${((Date.now() - testStartTime) / 1000).toFixed(1)}s`);
            } catch (error) {
                log(`âŒ Test error: ${error.message}`);
            }

            isTestRunning = false;
            document.getElementById('startTest').disabled = false;
            document.getElementById('stopTest').disabled = true;
            clearInterval(progressInterval);
            updateSummary();
        };

        // Stop test
        const stopTest = () => {
            isTestRunning = false;
            document.getElementById('startTest').disabled = false;
            document.getElementById('stopTest').disabled = true;
            log('â¹ï¸ Test stopped by user');
        };

        // Clear results
        const clearResults = () => {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('logOutput').innerHTML = '';
            document.getElementById('summarySection').style.display = 'none';
            testUsers = [];
            log('ðŸ§¹ Results cleared');
        };

        // Initialize
        log('ðŸ“‹ Multi-User Queue Test Interface Ready');
        log('ðŸ’¡ This interface shows a demo of the testing process');
        log('ðŸ”§ For actual testing, use the Node.js scripts:');
        log('   â€¢ test-multiple-users.js (HTTP server required)');
        log('   â€¢ test-queue-local.js (local database testing)');
    </script>
</body>
</html>